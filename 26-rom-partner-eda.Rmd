---
title: "21-rom-partner"
output: 
  html_notebook:
    toc: true
    toc_float: true
    theme: lumen
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

The purpose of this document is to perform EDA on the romantic partner formation variables (29 used).
The romantic partner formation variables are: \ 

'h3mr1', 'h3mr3_a', 'h3mr6_a', 'h3mr3_b', 'h3mr6_b', 'h3bm2',
'h4rd7b', 'h4rd7d', 'h4rd7e', 'h4rd9', 'h4rd12', 'h4tr14',
'h5tr1', 'h5tr6', 'h5hr1', 'h5tr4', 'h5hr2', 'h5tr1', 'h5tr3', 'h5tr5', 'h5tr7' \

Combine to be meaningful:
'h5tr4m', 'h5tr4y', 'h5tr5m', 'h5tr5y', 'h5tr6m','h5tr6y', 'h5tr7m', 'h5tr7y'


# Libraries and data import

```{r load libraries}
# Load required libraries
# librarian::shelf(DataExplorer, tictoc, quiet = TRUE) ---- does not work
# install.packages("DataExplorer")
library(DataExplorer)
# install.packages("tictoc")
library(tictoc)
# install.packages("stringr")
library(stringr)
# Libraries
if (!require("pacman")) install.packages("pacman")
pacman::p_load(SASxport, haven, dplyr, tidyr, janitor, naniar, ggplot2, Hmisc, purrr, scales, reshape, HH, tibble, likert, reshape2,forcats,splitstackshape,rsample,corrplot, correlationfunnel,gridExtra,graphics)
```


```{r read in data, cache=TRUE}
# Create path names - we need all waves for exploring depression
wave_files_all <- str_c("/scratch/p_gaydosh_dsi/Gaydosh/Core Files/In Home Interview Files/wave"
               ,c(1, 3:5),
               ".xpt")
# read in files with map and time it
# About 1 minute to read in data
wave_data_all <- wave_files_all %>%
  purrr::map(read_xpt)
```



```{r join data, cache=TRUE}
# Join data into a single data frame with wave 5
data_combined_all <- wave_data_all[[1]] %>% 
                      left_join(wave_data_all[[2]], by = "AID") %>%
                      left_join(wave_data_all[[3]], by = "AID") %>%
                      #left_join(wave_data_all[[4]], by = "AID") %>%
                      inner_join(wave_data_all[[4]], by = "AID") %>%
  clean_names(case = "snake")
# Determine if anything was not joined in, 5575 rows
not_joined_all <- anti_join(wave_data_all[[1]], wave_data_all[[2]], wave_data_all[[3]],wave_data_all[[4]],by = "AID")
```
Note that there are 5575 unique AID values are not joined, and they will not be used in further exploration.



# Selecting Variables

```{r brief exploration of variable sets, eval=TRUE, include=FALSE, echo=FALSE}
# health behavior variables as listed above
rp_list <- c(
                     'h3mr1', 'h3mr3_a', 'h3mr6_a', 'h3mr3_b', 'h3mr6_b', 'h3bm2', #wave 3
                    'h4rd7b', 'h4rd7d', 'h4rd7e', 'h4rd9', 'h4rd12', #'h4tr14', #wave 4
                    'h5tr1', 'h5tr6', 'h5hr1', 'h5tr4', 'h5hr2', 'h5tr1', 
                    'h5tr3', 'h5tr5', 'h5tr7',
                    'h5tr4m', 'h5tr4y', 'h5tr5m', 'h5tr5y', 'h5tr6m','h5tr6y', 'h5tr7m', 'h5tr7y') # Wave 5

```


```{r select variables of interest, warning=FALSE, include=FALSE}
# for all the four waves
final_data_all <- data_combined_all %>%
  dplyr::select(aid, tidyselect::all_of(rp_list))%>%
  #calculate years of involvement
  mutate(spouse_time = h5tr4m/12 + h5tr4y)%>%
  mutate(partner_time = h5tr5m/12 + h5tr5y)%>%
  mutate(date_time = h5tr6m/12 + h5tr6y)%>%
  mutate(last_pt_time = h5tr7m/12 + h5tr7y)%>%
  dplyr::select(-c('h5tr4m', 'h5tr4y', 'h5tr5m', 'h5tr5y', 'h5tr6m','h5tr6y', 'h5tr7m', 'h5tr7y'))
```



# Begin to understand the dataset with introductory plot

```{r}
final_data_all %>% 
  plot_intro()
```

About 10% missing observations 



# Missing value exploration

```{r, fig.width=15,fig.height=10}
# Overview of missing data
final_data_all %>% 
  plot_missing()
```

From `plot_missing()` we see that the highest missingess is from a constructed variable from wave 5. Otherwise, we see that wave 3 has the most missingness followed by waves 4 and 5.

Then, how many people have missing values across multiple variables? 


```{r how many people have missing values across multiple variables}
# Gain insight into who has these missing values. 
# Are these missing values the same people?
# Get the actual values of missingness we care about
missing_counts_all <- final_data_all %>%
  map_df(~sum(is.na(.))) %>% 
  pivot_longer(cols = everything(),
               names_to = "var") %>%
  filter(value > 1)%>%
  arrange(value)
# Names of variables with missingness we care about, 38 in total
missing_vars_all <- missing_counts_all %>% pull(var)
# Get total missingness by each individual across all variables
total_missing_all <- final_data_all %>% 
  dplyr::select(all_of(missing_vars_all)) %>% 
  rowwise() %>% 
  is.na() %>%
  rowSums()
# Bar plot of missingness for variables with more than 1 person missing
final_data_all %>% 
  mutate(tot_miss = total_missing_all) %>% 
  dplyr::select(aid, tot_miss) %>% 
  group_by(tot_miss) %>% 
  summarise(counts = n()) %>% 
  ggplot() +
  geom_bar(aes(x = tot_miss, y = counts), stat = "identity", fill = "light blue") +
  scale_x_continuous(breaks = seq(0,38,1)) +
  scale_y_continuous(breaks = seq(0,11e3, 1e3)) +
  ggtitle("Count of individuals with different numbers of missing variables") +
  xlab("Number of variables with missing value") +
  theme_dark()
```

From the barplot we see that about 3500 people are missing one variable, which could be the constructed variable about years with spouse. Besides, about 9000 have no missing values which means that they participated into all the wave1, wave3, wave4, and wave5. Using `drop_na()` will result in too much missing information without explanation for why those people are missing those variables.


Additional questions possible to answer in iteration: \

  1. Are these variables redundant to each other? \
  2. Do they cluster together? If so, how? \
  3. Are they predictive of each other? \
  4. Are they correlated?


```{r}
# replace all missing values with 99 for the sake of exploring correlation
cor_dat_input <- final_data_all %>%
  dplyr::select(all_of(missing_vars_all)) %>%
  mutate_all(~replace_na(., 99)) #

cor_dat_all <- cor_dat_input%>%
  cor(method = "kendall")

```
```{r correlation plot among variables with high missingness, cache=TRUE, fig.width=15,fig.height=12}
# Correlation plot of missing variables
cor_dat_all %>% 
  corrplot::corrplot(method = "color",
                     type = "upper",
                     order = "hclust",
                     diag = FALSE,
                     addCoef.col = "black")
```


# Explore change over time

```{r assess change over time of selected health behaviors, warning = FALSE}

# function for histograms
hist_by_var <-function(df, vars, max_val, title = title){
  ggplot(gather(df[,which(colnames(df) %in% vars)]), aes(x= value)) + 
    geom_bar(stat = 'count') + 
    facet_wrap(~key, scales = 'free_x')+
    ggtitle(title)+
    theme_minimal()+
    theme(plot.title=element_text(hjust=0.5))+
    xlim(NA ,max_val)
}

#these questions were asked basically in the same way across waves
q1_rp <- hist_by_var(final_data_all, c('h3mr1', 'h4tr1', 'h5tr1'), 5, "marriage frequency")

grid.arrange(q1_rp, nrow = 1)
 
```


Here is the visualization of how answers change for the same question over different waves. Marriage frequency increases over time, which is logical.


# Look at correlation of predictor variables with outcome of interest (depression, anxiety, optimism)
```{r correlation funnel for variables most of interest, warning=FALSE, cache=TRUE}
rp_and_outcomes <- c(rp_list, 
                    "h5ss0b", "h4pe6", "h4pe7") #depression, anxiety, optimism

final_data_corr <- data_combined_all %>%
  dplyr::select(aid, tidyselect::all_of(rp_and_outcomes)) %>%
  #calculate years of involvement
  mutate(spouse_time = h5tr4m/12 + h5tr4y)%>%
  mutate(partner_time = h5tr5m/12 + h5tr5y)%>%
  mutate(date_time = h5tr6m/12 + h5tr6y)%>%
  mutate(last_pt_time = h5tr7m/12 + h5tr7y)%>%
  dplyr::select(-c('h5tr4m', 'h5tr4y', 'h5tr5m', 'h5tr5y', 'h5tr6m','h5tr6y', 'h5tr7m', 'h5tr7y'))

# Plot correlation funnel h5ss0b:felt depressed variable. Note, all missing values are dropped.
final_data_corr %>% 
  dplyr::select(-aid) %>% 
  drop_na() %>%
  correlationfunnel::correlate("h5ss0b", method = "kendall") %>% 
  correlationfunnel::plot_correlation_funnel()

final_data_corr %>% 
  dplyr::select(-aid) %>% 
  drop_na() %>%
  correlationfunnel::correlate("h4pe6", method = "kendall") %>% 
  correlationfunnel::plot_correlation_funnel()

final_data_corr %>% 
  dplyr::select(-aid) %>% 
  drop_na() %>%
  correlationfunnel::correlate("h4pe7", method = "kendall") %>% 
  correlationfunnel::plot_correlation_funnel()

```


There are no particulalry notable correlations.



<br><br><br><br><br><br>