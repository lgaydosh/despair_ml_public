---
title: "21-stress-events"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: lumen
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

The purpose of this document is to perform EDA on stressful life event variables (39 used).
The stressful live event variables are: 
'h1gh54',
'h3lm38', 'h3lm39',
'h4mh29', 'h4id9c', 'h4mi1','h4mi3',
'h5mn5a', 'h5mn5b', 'h5mn5c', 'h5mn5d', 'h5mn5e',
'h5mn6a', 'h5mn6b', 'h5mn6c', 'h5mn6d', 'h5mn6e', 'h5mn6f', 'h5mn6g', 
'h5mn6h', 'h5mn6i', 'h5mn6j', 'h5mn6k', 'h5mn6l', 'h5mn6m', 'h5mn6n',
'h5tr21', 'h5tr22', 'h5tr23', 'h5tr24', 'h5tr25', 'h5tr26', 'h5tr27', 'h5tr28',
'h5ec8', 'h5da2', 'h5se17', 'h5se19', 'h5lm3'

Other (unused): C4VAR002

# Libraries and data import

```{r load libraries}
# Load required libraries
# librarian::shelf(DataExplorer, tictoc, quiet = TRUE) ---- does not work
# install.packages("DataExplorer")
library(DataExplorer)
# install.packages("tictoc")
library(tictoc)
# install.packages("stringr")
library(stringr)
# Libraries
if (!require("pacman")) install.packages("pacman")
pacman::p_load(SASxport, haven, dplyr, tidyr, janitor, naniar, ggplot2, Hmisc, purrr, scales, reshape, HH, tibble, likert, reshape2,forcats,splitstackshape,rsample,corrplot, correlationfunnel,gridExtra,graphics)
```


```{r read in data, cache=TRUE}
# Create path names - we need all waves for exploring depression
wave_files_all <- str_c("Z:/Gaydosh/Core Files/In Home Interview Files/wave"
               ,c(1, 3:5),
               ".xpt")
# read in files with map and time it
# About 1 minute to read in data
wave_data_all <- wave_files_all %>%
  purrr::map(read_xpt)
```



```{r join data, cache=TRUE}
# Join data into a single data frame with wave 5
data_combined_all <- wave_data_all[[1]] %>% 
                      left_join(wave_data_all[[2]], by = "AID") %>%
                      left_join(wave_data_all[[3]], by = "AID") %>%
                      #left_join(wave_data_all[[4]], by = "AID") %>%
                      inner_join(wave_data_all[[4]], by = "AID") %>%
  clean_names(case = "snake")
# Determine if anything was not joined in, 5575 rows
not_joined_all <- anti_join(wave_data_all[[1]], wave_data_all[[2]], wave_data_all[[3]],wave_data_all[[4]],by = "AID")
```
Note that there are 5575 unique AID values are not joined, and they will not be used in further exploration.



# Selecting Variables

```{r brief exploration of variable sets, eval=TRUE, include=FALSE, echo=FALSE}
# health behavior variables as listed above
str_list <- c(
            'h1gh54',
'h3lm38', 'h3lm39',
'h4mh29', 'h4id9c', 'h4mi1','h4mi3',
'h5mn5a', 'h5mn5b', 'h5mn5c', 'h5mn5d', 'h5mn5e',
'h5mn6a', 'h5mn6b', 'h5mn6c', 'h5mn6d', 'h5mn6e', 'h5mn6f', 'h5mn6g', 
'h5mn6h', 'h5mn6i', 'h5mn6j', 'h5mn6k', 'h5mn6l', 'h5mn6m', 'h5mn6n',
'h5tr21', 'h5tr22', 'h5tr23', 'h5tr24', 'h5tr25', 'h5tr26', 'h5tr27', 'h5tr28',
'h5ec8', 'h5da2', 'h5se17', 'h5se19', 'h5lm3') # Wave 5

```


```{r select variables of interest, warning=FALSE, include=FALSE}
# for all the four waves
final_data_all <- data_combined_all %>%
  dplyr::select(aid, tidyselect::all_of(str_list))
```



# Begin to understand the dataset with introductory plot

```{r}
final_data_all %>% 
  plot_intro()
```

About 6% missing observations



# Missing value exploration

```{r, fig.width=15,fig.height=10}
# Overview of missing data
final_data_all %>% 
  plot_missing()
```

From `plot_missing()` we see that 3 variables have over 24% missingness.


Then, how many people have missing values across multiple variables? 


```{r how many people have missing values across multiple variables}
# Gain insight into who has these missing values. 
# Are these missing values the same people?
# Get the actual values of missingness we care about
missing_counts_all <- final_data_all %>%
  map_df(~sum(is.na(.))) %>% 
  pivot_longer(cols = everything(),
               names_to = "var") %>%
  filter(value > 1)%>%
  arrange(value)
# Names of variables with missingness we care about, 38 in total
missing_vars_all <- missing_counts_all %>% pull(var)
# Get total missingness by each individual across all variables
total_missing_all <- final_data_all %>% 
  dplyr::select(all_of(missing_vars_all)) %>% 
  rowwise() %>% 
  is.na() %>%
  rowSums()
# Bar plot of missingness for variables with more than 1 person missing
final_data_all %>% 
  mutate(tot_miss = total_missing_all) %>% 
  dplyr::select(aid, tot_miss) %>% 
  group_by(tot_miss) %>% 
  summarise(counts = n()) %>% 
  ggplot() +
  geom_bar(aes(x = tot_miss, y = counts), stat = "identity", fill = "light blue") +
  scale_x_continuous(breaks = seq(0,38,1)) +
  scale_y_continuous(breaks = seq(0,11e3, 1e3)) +
  ggtitle("Count of individuals with different numbers of missing variables") +
  xlab("Number of variables with missing value") +
  theme_dark()
```

From the barplot we see that about 1500 people have 3 missing variables (there are 3 variables with over 24% missingness)/ Besides, about 9000 have no missing values which means that they participated into all the wave4 and wave5. Using `drop_na()` will result in too much missing information without explanation for why those people are missing those variables.


Additional questions possible to answer in iteration: \

  1. Are these variables redundant to each other? \
  2. Do they cluster together? If so, how? \
  3. Are they predictive of each other? \
  4. Are they correlated?


```{r}
# replace all missing values with 99 for the sake of exploring correlation
cor_dat_input <- final_data_all %>%
  dplyr::select(all_of(missing_vars_all)) %>%
  mutate_all(~replace_na(., 99)) #

cor_dat_all <- cor_dat_input%>%
  cor(method = "kendall")

```
```{r correlation plot among variables with high missingness, cache=TRUE, fig.width=15,fig.height=12}
# Correlation plot of missing variables
cor_dat_all %>% 
  corrplot::corrplot(method = "color",
                     type = "upper",
                     order = "hclust",
                     diag = FALSE,
                     addCoef.col = "black")
```


# Explore change over time- no questions were aksed consistently across waves

```{r assess change over time of selected health behaviors, warning = FALSE}

# function for histograms
hist_by_var <-function(df, vars, max_val, title = title){
  ggplot(gather(df[,which(colnames(df) %in% vars)]), aes(x= value)) + 
    geom_bar(stat = 'count') + 
    facet_wrap(~key, scales = 'free_x')+
    ggtitle(title)+
    theme_minimal()+
    theme(plot.title=element_text(hjust=0.5))+
    xlim(NA ,max_val)
}

#no questions were asked exactly the same across waves 4 and 5, can recode h4mh29?
 
```



# Look at correlation of predictor variables with outcome of interest (depression, anxiety, optimism)
```{r correlation funnel for variables most of interest, warning=FALSE, cache=TRUE}
str_and_outcomes <- c(str_list, "h5ss0b", "h4pe6", "h4pe7") #depression, anxiety, optimism

final_data_corr <- data_combined_all %>%
  dplyr::select(aid, tidyselect::all_of(str_and_outcomes))

# Plot correlation funnel h5ss0b:felt depressed variable. Note, all missing values are dropped.
final_data_corr %>% 
  dplyr::select(-aid) %>% 
  drop_na() %>%
  correlationfunnel::correlate("h5ss0b", method = "kendall") %>% 
  correlationfunnel::plot_correlation_funnel()

final_data_corr %>% 
  dplyr::select(-aid) %>% 
  drop_na() %>%
  correlationfunnel::correlate("h4pe6", method = "kendall") %>% 
  correlationfunnel::plot_correlation_funnel()

final_data_corr %>% 
  dplyr::select(-aid) %>% 
  drop_na() %>%
  correlationfunnel::correlate("h4pe7", method = "kendall") %>% 
  correlationfunnel::plot_correlation_funnel()

```


There are no particulalry notable correlations.



<br><br><br><br><br><br>