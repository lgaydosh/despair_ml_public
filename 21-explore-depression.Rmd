---
title: "21-explore-depression"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: lumen
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

# Purpose

The purpose of this document is to perform EDA on the depression outcome variables. For the sake of this exploration, we'll focus in on `h4mh18` ("bothered by things") after looking generally at missingness in the data. 

The depression variables are: \ 

  **Wave 1**:\
    1. `h1fs1`: bothered by things \
    2. `h1fs3`: shake off blues \
    3. `h1fs4`: felt as good as others \
    4. `h1fs5`: trouble concentrating \
    5. `h1fs6`: felt depressed \
    6. `h1fs7`: felt too tired \
    7. `h1fs11`: felt happy \
    8. `h1fs15`: enjoyed life \
    9. `h1fs16`: felt sad \
    10. `h1fs17`: felt disliked \
    \
  **Wave 3**:\
    1. `h3sp5`: bothered by things \
    2. `h3sp6`: shake off blues \
    3. `h3sp7`: felt as good as others \
    4. `h3sp8`: trouble concentrating \
    5. `h3sp9`: felt depressed \
    6. `h3sp10`: felt too tired \
    7. `h3sp11`: enjoyed life \
    8. `h3sp12`: felt sad \
    9. `h3sp13`: felt disliked \
    \   
  **Wave 4**:\
    1. `h4mh18`: bothered by things \
    2. `h4mh19`: shake off blues \
    3. `h4mh20`: felt as good as others \
    4. `h4mh21`: trouble concentrating \
    5. `h4mh22`: felt depressed \
    6. `h4mh23`: felt too tired \
    7. `h4mh24`: felt happy \
    8. `h4mh25`: enjoyed life \
    9. `h4mh26`: felt sad \
    10. `h4mh27`: felt disliked \
    \
  **Wave 5**:\
    1. `h5ss0a`: shake off blues \
    2. `h5ss0b`: felt depressed \
    3. `h5ss0c`: felt happy \
    4. `h5ss0d`: felt sad \



# Libraries and data import

```{r load libraries}
# Load required libraries
# librarian::shelf(DataExplorer, tictoc, quiet = TRUE) ---- does not work
# install.packages("DataExplorer")
library(DataExplorer)
# install.packages("tictoc")
library(tictoc)
# install.packages("stringr")
library(stringr)
# Libraries
if (!require("pacman")) install.packages("pacman")
pacman::p_load(SASxport, haven, dplyr, tidyr, janitor, naniar, ggplot2, Hmisc, purrr, scales, reshape, HH, tibble, likert, reshape2,forcats,splitstackshape,rsample,corrplot, correlationfunnel,gridExtra,graphics)
```


```{r read in data, cache=TRUE}

# Create path names - we need all waves for exploring depression
wave_files_all <- str_c("Z:/Gaydosh/Core Files/In Home Interview Files/wave"
               ,c(1, 3:5),
               ".xpt")

# read in files with map and time it
# About 1 minute to read in data
wave_data_all <- wave_files_all %>%
  purrr::map(read_xpt)
```



```{r join data, cache=TRUE}
# Join data into a single data frame
data_combined_all <- wave_data_all[[1]] %>% 
                      left_join(wave_data_all[[2]], by = "AID") %>%
                      left_join(wave_data_all[[3]], by = "AID") %>%
                      left_join(wave_data_all[[4]], by = "AID") %>% 
  clean_names(case = "snake")

# Determine if anything was not joined in, 5575 rows
not_joined_all <- anti_join(wave_data_all[[1]], wave_data_all[[2]], wave_data_all[[3]],wave_data_all[[4]],by = "AID")
```
Note that there are 5575 unique AID values are not joined, and they will not be used in further exploration.



# Selecting Variables

```{r brief exploration of variable sets, eval=TRUE, include=FALSE, echo=FALSE}
# have depression_list and predictor_list From file 10
depression_list <- c(
                     "h1fs1","h1fs3","h1fs4","h1fs5","h1fs6","h1fs7","h1fs11","h1fs15","h1fs16","h1fs17",   # Wave 1 ~ 10 vars
                     "h3sp5","h3sp6","h3sp7","h3sp8","h3sp9","h3sp10","h3sp11","h3sp12","h3sp13",           # Wave 3 ~ 9 vars
                     "h4mh18","h4mh19",'h4mh20','h4mh21',"h4mh22","h4mh23","h4mh24","h4mh26","h4mh27",      # Wave 4 ~ 9 vars
                     "h5ss0a","h5ss0b","h5ss0c","h4mh25","h5ss0d")                                          # Wave 5 ~ 5 vars

# Predictors of interest
predictor_list <- c("h4id5j",
         "h4pe6",
         "h4pe14",
         "h4pe22",
         "h4pe30",
         "h4pe7",
         "h4pe15",
         "h4pe23",
         "h4pe31",
         "h5id6i",
         "h5pe1",
         "h5pe2",
         "h5pe3",
         "h1fs1",
         "h3sp5",
         "h4mh18",
         "h1fs3",
         "h3sp6",
         "h4mh19",
         "h5ss0a",
         "h1fs4",
         "h3sp7",
         "h4mh20",
         "h1fs5",
         "h3sp8",
         "h4mh21",
         "h1fs6",
         "h3sp9",
         "h4mh22",
         "h5ss0b",
         "h1fs7",	
         "h3sp10",
         "h4mh23",
         "h1fs11",
         "h4mh24",
         "h5ss0c",
         "h1fs15",
         "h3sp11",
         "h4mh25",
         "h1fs16",
         "h3sp12",
         "h4mh26",
         "h5ss0d",
         "h1fs17",
         "h3sp13",
         "h4mh27",
         "h4id5h",
         "h5id6g")
# TRUE for all: all depression variables in predictor list
depression_list %in% predictor_list
```


```{r select variables of interest, warning=FALSE, include=FALSE}
# for all the four waves
final_data_all <- data_combined_all %>%
  dplyr::select(aid, tidyselect::all_of(predictor_list))
```



# Begin to understand the dataset with introductory plot

```{r}
final_data_all %>% 
  plot_intro()
```
About 22.4% missing observations which remind us to be careful when deciding to drop NA.



# Missing value exploration

```{r, fig.width=15,fig.height=10}

# Overview of missing data
final_data_all %>% 
  plot_missing()
```

From `plot_missing()` we see that there are 9 variables with over 40% missingness. We also see that wave1 variables all have zero percent missingness. It is interesting to see that the missingness percentages are pretty similar within each wave.

Then, how many people have missing values across multiple variables? 


```{r how many people have missing values across multiple variables}
# Gain insight into who has these missing values. 
# Are these missing values the same people?

# Get the actual values of missingness we care about
missing_counts_all <- final_data_all %>%
  map_df(~sum(is.na(.))) %>% 
  pivot_longer(cols = everything(),
               names_to = "var") %>%
  filter(value > 1)%>%
  arrange(value)

# Names of variables with missingness we care about, 38 in total
missing_vars_all <- missing_counts_all %>% pull(var)

# Get total missingness by each individual across all variables
total_missing_all <- final_data_all %>% 
  dplyr::select(all_of(missing_vars_all)) %>% 
  rowwise() %>% 
  is.na() %>%
  rowSums()

# Bar plot of missingness for variables with more than 1 person missing
final_data_all %>% 
  mutate(tot_miss = total_missing_all) %>% 
  dplyr::select(aid, tot_miss) %>% 
  group_by(tot_miss) %>% 
  summarise(counts = n()) %>% 
  ggplot() +
  geom_bar(aes(x = tot_miss, y = counts), stat = "identity", fill = "light blue") +
  scale_x_continuous(breaks = seq(0,38,1)) +
  scale_y_continuous(breaks = seq(0,11e3, 1e3)) +
  ggtitle("Count of individuals with different numbers of missing variables") +
  xlab("Number of variables with missing value") +
  theme_dark()
```

From the barplot we see that about 2500 people have 38 variables missing. Notice that the number of variables with missingness is 38, which means that there are about 2500 people only participated in wave1 survey. About 5000 have 9 variables missing. Notice that, from the above general missingness plot,  the two waves (wave3 and wave5) with higher missing data rates all have 9 variables. This could be the reason of causing about 5000 people have 9 variable data missing. Besides, about 9000 have no missing values which means that they participated into all the wave1, wave3, wave4, and wave5. Using `drop_na()` will result in too much missing information without explanation for why those people are missing those variables.


Additional questions possible to answer in iteration: \

  1. Are these variables redundant to each other? \
  2. Do they cluster together? If so, how? \
  3. Are they predictive of each other? \
  4. Are they correlated?


```{r correlation plot among variables with high missingness, cache=TRUE, fig.width=15,fig.height=12}

# replace all missing values with 99 for the sake of exploring correlation
cor_dat_all <- final_data_all %>% 
  dplyr::select(all_of(missing_vars_all)) %>% 
  mutate_all(~replace_na(., 99)) %>% 
  cor(method = "kendall")

# Correlation plot of missing variables
cor_dat_all %>% 
  corrplot::corrplot(method = "color", 
                     type = "upper", 
                     order = "hclust", 
                     diag = FALSE, 
                     addCoef.col = "black")

```



# Explore predictor variables

```{r assess change over time of primary outcome, warning = FALSE}
# depression data set get from 11, 10
predictor_vars <- data_combined_all[which(colnames(data_combined_all) %in% predictor_list)]
depression<- predictor_vars[depression_list]
# 
hist_by_var <-function(df,vars, title = title){
  ggplot(gather(df[,which(colnames(df) %in% vars)]), aes(x= value)) + 
    geom_bar(stat = 'count') + 
    facet_wrap(~key, scales = 'free_x')+
    ggtitle(title)+
    theme_minimal()+
    theme(plot.title=element_text(hjust=0.5))
}
# depression_compare(primary_DEPoutcome,h5ss0a,h4mh19)

q1_depression <- hist_by_var(depression, c('h1fs1',"h3sp5","h4mh18"), "bothered by things")
q2_depression <- hist_by_var(depression, c("h1fs3","h3sp6","h4mh19","h5ss0a"), "shake off blues")
q3_depression <- hist_by_var(depression, c("h1fs4","h3sp7","h4mh20"), "felt as good as others")
q4_depression <- hist_by_var(depression, c("h1fs5","h3sp8","h4mh21"), "trouble concentrating")
q5_depression <- hist_by_var(depression, c("h1fs6","h3sp9","h4mh22",	"h5ss0b"), "felt depressed")
q6_depression <- hist_by_var(depression, c("h1fs7","h3sp10",	"h4mh23"), "felt too tired")
q7_depression <- hist_by_var(depression, c("h1fs11","h4mh24","h5ss0c"), "felt happy")
q8_depression <-hist_by_var(depression, c("h1fs15","h3sp11","h4mh25"), "enjoyed life")
q9_depression <-hist_by_var(depression, c("h1fs16","h3sp12","h4mh26","h5ss0d"), "felt sad")
q10_depression <- hist_by_var(depression, c("h1fs17","h3sp13","h4mh27"), "felt disliked")
grid.arrange(q1_depression, q2_depression, q3_depression, q4_depression, q5_depression, q6_depression, nrow = 2)
grid.arrange(q7_depression, q8_depression, q9_depression, q10_depression, nrow = 2)             
 
```

Here is the visualization of how answers change for the same question over different waves. Notice that scale may be changed even on the same question. Think about rescaling for better visualization analysis. Based on what we have here, the over all distribution is not changed much for each question. Does that mean people's feeling towards depression not change much from their childhood to adulthood? Even for some people, the condition gets worse? For example, look at the change for the number of people who answered 1 for the question "felt as good as others".


# Look at correlation of predictor variables with outcome of interest
```{r correlation funnel for variables most of interest, warning=FALSE, cache=TRUE}
# Plot correlation funnel h5ss0b:felt depressed variable. Note, all missing values are dropped.
final_data_all %>% 
  dplyr::select(-aid) %>% 
  drop_na() %>%
  correlationfunnel::correlate("h5ss0b", method = "kendall") %>% 
  correlationfunnel::plot_correlation_funnel()
```


The correlation funnel above shows us that the most correlated variables with `h5ss0b` are `h5ss0a` and `h5ss0d`, which make sense because they're both questions regarding depression on bad emotional feelings. `h5ss0a` is shake off blues and `h5ss0d` is felt sad. At the other end of the spectrum, we see that the least correlated variable is `h1fs4`: felt as good as others.


<br><br><br><br><br><br>