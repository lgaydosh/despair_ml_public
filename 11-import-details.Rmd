---
title: "10-import-data"
output:
  html_document: 
    code_folding: show
    theme: cosmo
    toc: yes
    toc_depth: 5
    toc_float: true
editor_options: 
  chunk_output_type: inline
---

Note: See bottom of file for description of data

# Libraries
```{r load libraries }
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, haven, janitor, ggplot2, purrr, likert, forcats, rsample, tictoc)
```

```{r initializing h2o }
h2o.init(nthreads = -1,
         max_mem_size = "8G")  
```

```{r loading all wave files }
# while running this make sure all the waves are being loaded into the dataset
files <- choose.files(default = "", caption = "Select files",
                      multi = TRUE, filters = Filters,
                      index = nrow(Filters))

for (i in 1:length(files)){
  assign(paste0('wave',i), read_xpt(files[i] ))
}
```

Run below chunk to import the constructed variable for race
```{r loading race (constructed) variable }
race_file <- choose.files(default = "", caption = "Select files",
                          multi = TRUE, filters = Filters,
                          index = nrow(Filters))
race <- read_xpt(race_file) %>% clean_names()
```

# Joined Wave Data

1. Skipping wave 2
2. Keeping only the observations that are present in all waves 1,3,4, and 5.
3. Doing a full join because of issues with factoring and creating the right number of labels for the variables. This will be used to later to filter after we have created the data subsets.
4. Construction of age variable at each wave
[Interview Completion Date](https://www.cpc.unc.edu/projects/addhealth/documentation/ace/tool/variablecollection?VariableCollectionId=2416) 
- variables IYEARX, IMONTHX, IDAYX 
- where X is the number of the wave (e.g. 1,3,4,5)

[Date of Birth](https://www.cpc.unc.edu/projects/addhealth/documentation/ace/tool/variablecollection?VariableCollectionId=2) 
- variables h1gi1m - month, h1gi1y - year

```{r convenience functions}
# This function will be used to join all the waves together. Potential option to join all waves together. 
# Note functionality to convert variables into factors - very hacky - may need to be fixed and/or talked about
join_waves <- function(wave1,wave2,wave3,wave4,wave5, inner = T){
  # wave1-wave5 : all the wave files loaded from the previous chunks
  # inner : If True, returns the inner join of all waves - subjects that were present in all waves, else returns an outer join
  # return : Inner or outer join of all waves
  
  all_wave_sbjs <- intersect(intersect(intersect(wave1$AID, wave3$AID), wave4$AID), wave5$AID)
  
  joined_waves <-  wave1 %>%
    #inner_join(wave2, by = "AID") %>%
    full_join(wave3, by = "AID") %>%
    full_join(wave4, by = "AID") %>%
    full_join(wave5, by = "AID") %>% 
    clean_names() %>% 
    mutate_at(vars(starts_with("h")|starts_with("r")|starts_with("m")), as.factor) %>% # Subject to change, this is under the assumption that essentially all the variables we are working with will be starting with 'h', 'r' or 'm'
    filter(aid %in% all_wave_sbjs, inner == T)
}


# This function will be used to add age and race demographic into the data
add_demographics <- function(df){
  # df : joined waves input
  # return : new data frame with race and age information at each wave. 
  #          age_w{x} - where x is the wave number (e.g. age_w5, age_w4..etc)
  # race info consists of three variables - mulrace1, race1, race1rul
  df %>% 
    mutate(birth_in_months = (as.double(paste("19",h1gi1y,sep=""))*12 )+ as.double(h1gi1m)) %>% 
    mutate(age_w1 = floor((((as.double(paste("19",iyear,sep=""))*12 )+imonth) - birth_in_months)/12) ) %>% 
    mutate(age_w3 = floor((((iyear3*12)+imonth3)-birth_in_months)/12)) %>% 
    mutate(age_w4 = floor((((iyear4*12)+imonth4)-birth_in_months)/12)) %>% 
    mutate(age_w5 = floor((((iyear5*12)+imonth5)-birth_in_months)/12)) %>% 
    dplyr::select(-one_of(c('birth_in_months'))) %>%
    
    mutate(one_race5 = case_when( #one race: first analyze those with multiple races
                        (h5od8==1) ~ 1, #1 = white
                        (h5od8==2) ~ 2, #2 = black
                        (h5od8>=3)&&(h5od8<=7) ~ 3, #3= hispanic
                        (h5od8>=9)&&(h5od8<=15) ~ 4, #4 = asian
                        (h5od8>=16)&&(h5od8<=22) ~ 5, #5 = other
                        #then analyze only 1 race response
                        (h5od4a==1) ~ 1, #1 = white
                        (h5od4b==1) ~ 2, #2 = black
                        (h5od4c==1) ~ 3, #3= hispanic
                        (h5od4d==1) ~ 4, #4 = asian
                        ((h5od4e==1)|(h5od4f==1)|(h5od4g==1)) ~ 5)) #other
                        #otherwise NA default
}


# This function is for subsetting the data by outcome and predictors
get_outcomes_df <- function(df, outcome, predictors){
  # df: dataframe that has all data in it
  # outcome: outcome variable of interest
  # predictor_vars: predictor variables of interest
  # returns: tibble with only outcome and predictors of interest
  
  # create tibble to return
  out <- df %>%
    dplyr::select(outcome, predictors)
  
  # return tibble
  return(out)
}


# Function to Check Existence of Variable in Data
# Use this function to check if a certain variable exists in a given. 
var_in_df <- function(df, varname){
  # df : dataframe to check in
  # varname : varaible to check for
  # return : Bool indicatind if the variable exists in the dataframe or not
  any(colnames(df) == varname)
}
## Examples of Usage : joined_waves %>% var_in("h4id5j")


# Function to check the counts by categories in the variables
count_response_by_variable <- function(df, ...){
  # df : dataframe where the variable exists
  # ... : variable you want to check the counts of - sent in as a string
  df %>% group_by_(...) %>% summarise(n = n())
}

#Functions to add outcomes of prescription and illegal drug uses
add_pres_drug <- function(df){
  # df : joined waves input
  # return : new data frame with additional variable indicating prescription drug use
  df %>% 
    mutate(p_drug = case_when(
                    ((h5to26a == 1)|(h5to26b == 1)|(h5to26c == 1)|(h5to26d == 1)) ~ 1,
                    ((h5to26a == 0)&(h5to26b == 0)&(h5to26c == 0)&(h5to26d == 0)) ~ 0)
    )
}
add_ill_drug <- function(df){
  # df : joined waves input
  # return : new data frame with additional variable indicating illegal drug use
  df %>% 
    mutate(i_drug = case_when(
                    ((h5to27a == 1)|(h5to27b == 1)|(h5to27c == 1)|(h5to27d == 1)) ~ 1,
                    ((h5to27a == 0)&(h5to27b == 0)&(h5to27c == 0)&(h5to27d == 0)) ~ 0)
    )
}


# Example of usage
# Tibble for first outcome with all of its predictors
# suicide_df <- joined_waves %>%
#   get_outcomes_df(outcome = "h5mn8", 
#                   predictors = setdiff(predictor_list, "aid"))
```




```{r join waves and add demographics}
joined_waves <- join_waves(wave1,wave2,wave3,wave4,wave5, inner = T) %>% 
  add_demographics()
```



# Lists of Relevant Predictor Variables
See 10 for the predictor variables.  It is dangerous to keep such lists updated in two places; invariably, someone will update the one, and use the other, unupdated one.

### Here, we ensure the functionality of the predictor lists; namely that they're all within the dataframe that is created.
```{r}
wave_data <- load_waves(1:5, filebase = 'G:')
full_dataset <- get_working_dataset_full(wave_data, join_type = 'full')
```

```{r}
vars_in_df <- predictor_list %>%
  map(~var_in_df(df=full_dataset, varname=.))

print("Variables which don't appear to tbe in the joined dataframe ")
predictor_list[vars_in_df==FALSE]
str_c("Number of variables which don't appear to be in dataframe: ", sum(!unlist(vars_in_df)))

```
It looks like we have 11 variables which aren't in the Wave 1-5 data somehow.  I looked in the ACE codebook for some of the Wave 4 predictors, but it, too, doesn't seem to think they're in our Wave data.

When I run thsi same code on the predictor list with the unsure variables (`unsure_variables`)removed, all of the variables are in the dataframe successfully.


# Different Tibbles of Interest
Using the lists generated in the above chunk to create subsets of data to work with. 
Using `get_outcomes` function 

```{r predictor subsets of interests}
# Note these subsets are used for easy visualization in the later parts

#Subset of data with all predictor variables
predictor_vars <- joined_waves[which(colnames(joined_waves) %in% predictor_list)] 
#Subset of data with all anxiety variables
anxiety <- predictor_vars[anxiety_list]
diag_anxiety <- predictor_vars[diagnosed_anxiety_list]

#Subset of all depression variables
depression<- predictor_vars[depression_list]
diag_depression <- predictor_vars[diagnosed_depression_list]

#Subset of data with all optimism variables
optimism <- predictor_vars[optimism_list]

```

```{r tibbles of interest for training}
# Tibble for first outcome with all of its predictors
suicide_df <- joined_waves %>%
  get_outcomes_df(outcome = "h5mn8", 
                  predictors = setdiff(predictor_list, "aid"))
```

# Lists of Relevant Outcome Variables
```{r lists of relevant outcome variables}
outcome_vars_list <- c("aid","h1su1","h3to130","h4se1","h5mn8", "h1to32","h3to110","h4to71","h5to21")

# List of suicidal ideation variables
# Question Text: During the past 12 months, have you ever seriously thought about committing suicide?

suicidal_list <- c("aid","h1su1","h3to130","h4se1","h5mn8")

# List of variables to indicate marijuana usage in the last 30 days
marijuana_outcome_use30_list <- c("aid", "h1to32","h3to110","h4to71","h5to21") #During the past 30 days, on how many days did you use marijuana?

```


# Outcome Variables Across All Waves Except Wave 2
```{r outcome subsets of intetest}
# Note these subsets are used for easy visualization in the later parts

# Subset of all combined outcomes
outcome_vars <- joined_waves[which(colnames(joined_waves) %in% outcome_vars_list)] 

# Subset of data with all suicidal ideation variables
suicidal_id_outcome <- outcome_vars[suicidal_list]

# Subset of data with all marijuana usage in last 30 days variables                            
marijuana_outcome_usage30 <- outcome_vars[marijuana_outcome_use30_list]
```

# Ensuring the behavior of loading the data
```{r test flexible filebase}
filebase = '/scratch/p_gaydosh_lab'

## load waves and join them
tic()
wave_data <- load_waves(1:5, filebase=filebase)
full_dataset <- get_working_dataset_full(wave_data, join_type = 'full')
toc()

## set outcome variable of interest
outcome = 'h5mn8'

## get the aids that you want
inner_aids <- get_inner(list(wave_data[[1]], wave_data[[3]], wave_data[[4]], wave_data[[5]]))

## use the features and ids that you want to select out what you want
working_ds <- full_dataset %>%
  remove_subjects_not_in_wave1(filebase=filebase) %>%
  add_demographics() %>%
  add_bio_despair(filebase=filebase) %>% 
  filter(aid %in% inner_aids) %>%
  dplyr::select(all_of(c('aid', predictor_list, demographic_age_list, demographic_list, outcome)))

working_ds %>% glimpse()

```
The above code chunk reveals that all variables are loaded correctly.

# Data

All data is structured. Source files are all SAS export files. This is a large dataset, collected in waves. The most recent is Wave 5, which includes the outcomes.

## Data Description/ Fields

Measures used:

Dependent variables: diseases of despair, including suicidal ideation, heavy/problem drinking, drug use, DSM-IV criteria for alcohol, marijuana, and other drug abuse and dependence

*	Suicidal ideation at Wave IV

+	Thoughts of suicide in the last 12 months

*	Alcohol use at Wave IV

+	Days drank alcohol in last 12 months

+	Drinks each time in last 12 months

+	Days drank alcohol in last 3 months

+	Drinks each time in last 3 months

+	Occasions of more than 4/5 drinks in a row in last 12 months

+	DSM4 lifetime diagnosis of alcohol abuse or dependence

*	Marijuana use at Wave IV

+	Times used in last 30 days

+	DSM4 lifetime diagnosis of cannabis abuse or dependence

*	Illegal drug use at Wave IV

+	DSM4 lifetime diagnosis of other drug use/dependence

+	Lifetime use of cocaine, crystal meth, heroin, other illegal drugs (separately)

*	Prescription drug abuse at Wave IV

+	Lifetime use of sedatives, tranquilizers, stimulants, painkillers (separately)

Key independent variables: measures of cognitive and emotional despair

*	Cognitive despair

+	Wave III personality measures of self-consciousness, persistence

*	Emotional despair

+	Wave I – III CES-D items

Other variables: 

*	Demographic controls for age at Wave IV, sex, race/ethnicity

*	Wave I – III predictors


#Unit tests
#missing factor
```{r}
recode_missing_factors<-function(df, na_levels){
  
  print("Recoding Missing Factor Variables")
  # function to replace skip levels in factor variables with NA
  # df: dataframe of wave data
  # na_levels: read data from na_levels.csv file
  
  
  
  var_names <- intersect(na_levels %>%  
                           filter(type == "Factor") %>%
                           select(variable_name) %>% 
                           pull() %>% tolower(), names(df))
  
  print(paste("Number of factor variables being recoded : ", length(var_names) ))
  print("Factor variables being recoded : ")
  print(var_names)
  
  for (i in 1:length(var_names)){
    
    print(var_names[i])
    mlevels <- na_levels %>% 
      filter(variable_name == var_names[i]) %>% 
      select(na_values) %>% 
      pull() %>% 
      str_split(',') %>% 
      .[[1]] %>% 
      as.character()
    
    if(!is.na(mlevels[1])){ 
            
      if (class(df[[var_names[[i]]]]) != "factor"){ # if the variable to be changed is not a factor already
        df[[var_names[[i]]]] <- df[[var_names[[i]]]] %>% as_factor() 
      }
      
      levels(df[[var_names[i]]])[levels(df[[var_names[i]]]) %in% mlevels] <- NA

    }

  }
  
  #df[var_names] <- lapply(df[var_names] , factor)
  print(sapply(df[var_names], class))
  
  return(df)
}


```
```{r}

# read csv file of NA values
# na_csv <- read_csv('na_levels.csv')
na_sheet <- read_excel("Variables_of_Interest.xlsx", sheet = 4) %>% clean_names()
na_sheet$variable_name <- na_sheet$variable_name %>% tolower()
#Test tibble
# test_df_fac <- tibble(
#   h1fs3 = as.factor(c(0, 1, 2, 3, NA, 6 , 8, 9, 100)), #allowable 0-3
#   h3sp4 = as.factor(c(NA, 6 , 8, 9, 0, 1, 2, 3, 100)), #allowable 0-3
#   h4pe14 = as.factor(c(NA, 5, 4, 3, 6, 8, 0, 29, 30)), #allowable 1-5
#   h5id62 = as.factor(c(0, 1, NA, 2, 3, 40, NA, 1, 0)) #allowable 0-1
# )

test_df_fac <- tibble(
  h1fs3 = as.factor(c(0, 1, 2, 3, NA, 6 , 8, 9, 100)), #allowable 0-3
  h3sp5 = as.factor(c(NA, 6 , 8, 9, 0, 1, 2, 3, 100)), #allowable 0-3
  h4pe14 = as.factor(c(NA, 5, 4, 3, 6, 8, 0, 29, 30)), #allowable 1-5
  h5id6g = as.factor(c(0, 1, NA, 2, 3, 40, NA, 1, 0)) #allowable 0-1
)

outcome_factors_data <- recode_missing_factors(test_df_fac, na_sheet)
```

#missing numeric
```{r}
recode_missing_numeric<-function(df, na_levels){
  # function to replace skip levels in factor variables with NA
  # df: dataframe of wave data
  # na_levels: read data from na_levels.csv file
  
  print("Recoding Missing Numeric Variables")
  var_names <- intersect(na_levels %>%
                           filter(type == "Numeric") %>% 
                           select(variable_name) %>% 
                           pull() %>% 
                           tolower(), names(df))
  
  print(paste("Number of numeric variables being recoded : ", length(var_names) ))
  print("Numeric variables being recoded : ")
  print(var_names)
  
  
  for (i in 1:length(var_names)){

    mlevels <- na_levels %>% 
      filter(variable_name == var_names[i]) %>% 
      select(na_values) %>% 
      pull() %>% 
      str_split(',') %>% 
      .[[1]]  

    
    if(!is.na(mlevels[1])){ # verify that the variable in question actually has missing levels
      
      df[,var_names[i]] <- ifelse(as.vector(pull(df[,var_names[i]]) %in% mlevels),
                                       NA, 
                                       pull(df[,var_names[i]]))
      # if the column of the numeric variable has values that are supposed to be skipped
      # replace them with NA
      # else keep the original value
      
    }
  }
  return(df)
}

```

```{r}

# read csv file of NA values
#na_csv <- read_csv('na_levels.csv')
na_sheet <- read_excel("Variables_of_Interest.xlsx", sheet = 4) %>% clean_names()
na_sheet$variable_name <- na_sheet$variable_name %>% tolower()
#Test tibble
test_df_num <- tibble(
  h3wgt = c(996, 888, 4, -6, NA, 78, 321.5, 400, 888), #allowable 78-330
  h4sbp = c(-3, 75.5, NA, 222.5, 996, 999, 997, 321, 223), #allowable 74-222.5
  h5waist = c(NA, 9994,9996, 50, 9997,9999, 189, 100.5, NA) #allowable 47-185
)

recode_missing_numeric(test_df_num, na_sheet)
```

#missing variable
```{r}
recode_variables <- function(df, sheet_num, outcome = NULL, binarize = TRUE){
  # Function to recode variables from different sheets in the variables_of_interest file
  ## we will use this function to load different variabless: despair predictors, relevant individual predictors, contextual predictors, outcome variables
  # df: dataframe of wave data
  # sheet_num : this sheet number
  # outcome : outcome variable of interest that needs to be recoded
  # binarize : if TRUE means that the outcome variable needs to be binarized
  
  
  sheet_df <- read_excel("Variables_of_Interest.xlsx", sheet = sheet_num) %>% clean_names()
  sheet_df$variable_name <- sheet_df$variable_name %>% tolower()
  
  if(is.null(outcome)){
    df <- recode_missing_factors(df, sheet_df) %>% 
      recode_missing_numeric(sheet_df)
    
    return(df)
  }
  
  else{
    df <- recode_missing_factors(df, sheet_df) %>% drop_na(outcome) # dropping rows where outcoome variable is NULL
    
    if(binarize == TRUE){
      fct_levels <- df %>% 
        select(outcome) %>% 
        pull() %>% 
        unique() %>% 
        as.vector()
      
      not_zero <- fct_levels[fct_levels != 0]
      
      
      df[outcome] <- fct_collapse(df[outcome] %>% pull() %>% as.vector(), "1" = not_zero)
      
      print(nrow(df))
    }
    
  }
  
  return(df)
}
```
```{r}
# read csv file of NA values
#na_csv <- read_csv('na_levels.csv')

#Test tibbles
test_df_vars1 <- tibble(
  h1fs3 = as.factor(c(0, 1, 2, 3, NA, 6 , 8, 9, 100)), #allowable 0-3
  h3sp5 = as.factor(c(NA, 6 , 8, 9, 0, 1, 2, 3, 100)), #allowable 0-3
  h4pe14 = as.factor(c(NA, 5, 4, 3, 6, 8, 0, 29, 30)), #allowable 1-5
  h5id6g = as.factor(c(0, 1, NA, 2, 3, 40, NA, 1, 0)), #allowable 0-1
  h3wgt = c(996, 888, 4, -6, NA, 78, 321.5, 400, 888), #allowable 78-330
  h4sbp = c(-3, 75.5, NA, 222.5, 996, 999, 997, 321, 223), #allowable 74-222.5
  h5waist = c(NA, 9994,9996, 50, 9997,9999, 189, 100.5, NA) #allowable 47-185
)
test_df_vars2 <- test_df_vars1

outcome_recode_bin <- recode_variables(test_df_vars1, sheet_num=4, outcome = NULL, binarize = TRUE)

outcome_recode_non <- recode_variables(test_df_vars2, sheet_num=4, outcome = NULL, binarize = FALSE)
```
