---
title: "21-social-int-iso"
output:
  html_notebook:
    code_folding: hide
    theme: lumen
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

The purpose of this document is to perform EDA on the social integration and isolation variables (30 used).
The social integration and isolation variables are: \ 




  **Wave 1**:\
    1. `h1pf35`: Feel socially accepted \
    2. `h1pf36`: Feel loved and wanted \
    3. `h1da7`: Time with friends last week \
    4. `fr_flag`: #  of friend nominations \
    5. `h1pr4`: How much friends care \
    6. `h1ed19`: Close to people at school \
    7. `h1ed20`: Feel like part of school \
    8. `h1ed22`: Feel happy to be at school \
    9. `h1fs13`: Felt lonely \
    10. `h1pr1`: How much adults care \
    11. `h1pr2`: How much teachers care \
    12. `h1pr4`: How much friends care \
    13. `h1nb3`: People in neighborhood watch out for each other \
    \
  **Wave 3**:\
    1. `h3da15`: Time with friends last week \
    \   
  **Wave 4**:\
    1. `h4ws4`: Number close friends \
    \
  **Wave 5**:\
    1. `h5ss6`: Number close friends  \
    2. `h5ss1`: Social gatherings frequency \
    3. `h5ss2`: Neighbor socialization frequency \
    4. `h5ss3a`: Opening up to spouse \
    5. `h5ss3b`: Opening up to children \
    6. `h5ss3c`: Opening up to family \
    7. `h5ss3d`: Opening up to friends \
    8. `h5ss4a`: Relying on spouse \
    9. `h5ss4b`: Relying on children \
    10. `h5ss4c`: Relying on family \
    11. `h5ss4d`: Relying on friends \
    12. `h5ss5a`: Criticism from spouse \
    13. `h5ss5b`: Criticism from children \
    14. `h5ss5c`: Criticism from family \
    15. `h5ss5d`: Criticism from friends \
    \


# Libraries and data import

```{r load libraries}
# Load required libraries
# librarian::shelf(DataExplorer, tictoc, quiet = TRUE) ---- does not work
# install.packages("DataExplorer")
library(DataExplorer)
# install.packages("tictoc")
library(tictoc)
# install.packages("stringr")
library(stringr)
# Libraries
if (!require("pacman")) install.packages("pacman")
pacman::p_load(SASxport, haven, dplyr, tidyr, janitor, naniar, ggplot2, Hmisc, purrr, scales, reshape, HH, tibble, likert, reshape2,forcats,splitstackshape,rsample,corrplot, correlationfunnel,gridExtra,graphics)
```


```{r read in data, cache=TRUE}
# Create path names - we need all waves for exploring depression
wave_files_all <- str_c("/scratch/p_gaydosh_dsi/Gaydosh/Core Files/In Home Interview Files/wave"
               ,c(1, 3:5),
               ".xpt")
# read in files with map and time it
# About 1 minute to read in data
wave_data_all <- wave_files_all %>%
  purrr::map(read_xpt)
```



```{r join data, cache=TRUE}
# Join data into a single data frame with wave 5
data_combined_all <- wave_data_all[[1]] %>% 
                      left_join(wave_data_all[[2]], by = "AID") %>%
                      left_join(wave_data_all[[3]], by = "AID") %>%
                      #left_join(wave_data_all[[4]], by = "AID") %>%
                      inner_join(wave_data_all[[4]], by = "AID") %>%
  clean_names(case = "snake")
# Determine if anything was not joined in, 5575 rows
not_joined_all <- anti_join(wave_data_all[[1]], wave_data_all[[2]], wave_data_all[[3]],wave_data_all[[4]],by = "AID")
```



# Selecting Variables

```{r brief exploration of variable sets, eval=TRUE, include=FALSE, echo=FALSE}
# social int and iso variables as listed above
ssi_list <- c(
              'h1pf35', 'h1pf36', 'h1da7', 'fr_flag', 'h1pr4', 
              'h1ed19', 'h1ed20', 'h1ed22', 'h1fs13', 'h1pr1', 'h1pr2', 'h1pr4', 'h1nb3',  # Wave 1 
              'h3da15',  # Wave 3
              'h4ws4',  # Wave 4 
              'h5ss6', 'h5ss1', 'h5ss2', 'h5ss3a', 'h5ss3b', 'h5ss3c', 'h5ss3d',
              'h5ss4a','h5ss4b','h5ss4c','h5ss4d', 'h5ss5a','h5ss5b', 'h5ss5c','h5ss5d') # Wave 5

```


```{r select variables of interest, warning=FALSE, include=FALSE}
# for all the four waves
final_data_all <- data_combined_all %>%
  dplyr::select(aid, tidyselect::all_of(ssi_list))
```



# Begin to understand the dataset with introductory plot

```{r}
final_data_all %>% 
  plot_intro()
```

About 2% missing observations



# Missing value exploration

```{r, fig.width=15,fig.height=10}
# Overview of missing data
final_data_all %>% 
  plot_missing()
```

From `plot_missing()` we see that wave 3 has the most missingness, followed by 4, 5, and 1.

Then, how many people have missing values across multiple variables? 


```{r how many people have missing values across multiple variables}
# Gain insight into who has these missing values. 
# Are these missing values the same people?
# Get the actual values of missingness we care about
missing_counts_all <- final_data_all %>%
  map_df(~sum(is.na(.))) %>% 
  pivot_longer(cols = everything(),
               names_to = "var") %>%
  filter(value > 1)%>%
  arrange(value)
# Names of variables with missingness we care about, 38 in total
missing_vars_all <- missing_counts_all %>% pull(var)
# Get total missingness by each individual across all variables
total_missing_all <- final_data_all %>% 
  dplyr::select(all_of(missing_vars_all)) %>% 
  rowwise() %>% 
  is.na() %>%
  rowSums()
# Bar plot of missingness for variables with more than 1 person missing
final_data_all %>% 
  mutate(tot_miss = total_missing_all) %>% 
  dplyr::select(aid, tot_miss) %>% 
  group_by(tot_miss) %>% 
  summarise(counts = n()) %>% 
  ggplot() +
  geom_bar(aes(x = tot_miss, y = counts), stat = "identity", fill = "light blue") +
  scale_x_continuous(breaks = seq(0,38,1)) +
  scale_y_continuous(breaks = seq(0,11e3, 1e3)) +
  ggtitle("Count of individuals with different numbers of missing variables") +
  xlab("Number of variables with missing value") +
  theme_dark()
```

From the barplot we see that almost 2500 people with 1 missing variable (wave 3 and 4 each has 1 variable). Besides, about 9000 have no missing values which means that they participated into all the wave1, wave3, wave4, and wave5. Using `drop_na()` will result in too much missing information without explanation for why those people are missing those variables.


Additional questions possible to answer in iteration: \

  1. Are these variables redundant to each other? \
  2. Do they cluster together? If so, how? \
  3. Are they predictive of each other? \
  4. Are they correlated?


```{r}
# replace all missing values with 99 for the sake of exploring correlation
cor_dat_input <- final_data_all %>%
  dplyr::select(all_of(missing_vars_all)) %>%
  mutate_all(~replace_na(., 99)) #

cor_dat_all <- cor_dat_input%>%
  cor(method = "kendall")

```
```{r correlation plot among variables with high missingness, cache=TRUE, fig.width=15,fig.height=12}
# Correlation plot of missing variables
cor_dat_all %>% 
  corrplot::corrplot(method = "color",
                     type = "upper",
                     order = "hclust",
                     diag = FALSE,
                     addCoef.col = "black")
```
correlation matrix takes too long


# Explore change over time

```{r assess change over time of selected health behaviors, warning = FALSE}
#new dataframe with only compare change over time values

# function for histograms
hist_by_var <-function(df, vars, max_val, title = title){
  ggplot(gather(df[,which(colnames(df) %in% vars)]), aes(x= value)) + 
    geom_bar(stat = 'count') + 
    facet_wrap(~key, scales = 'free_x')+
    ggtitle(title)+
    theme_minimal()+
    theme(plot.title=element_text(hjust=0.5))+
    xlim(NA ,max_val)
}

#these questions were asked basically in the same way across waves
q1_sii <- hist_by_var(final_data_all, c('h1da7','h3da15'), 8, "times with friends in last week")
q2_sii <- hist_by_var(final_data_all, c('h4ws4','h5ss6'),6,"#close friends (0, 1-2, 3-5, 6-9, 10+)")

grid.arrange(q1_sii,q2_sii, nrow = 1)
 
```


Here is the visualization of how answers change for the same question over different waves. For times with friends, the wave 1 categories actually ends at 3. Both waves responses are skewed left. For number of close friends, the distribution shape is roughly the same for both waves, with the mode at 3.


# Look at correlation of predictor variables with outcome of interest (depression, anxiety, optimism)
```{r correlation funnel for variables most of interest, warning=FALSE, cache=TRUE}
ssi_and_outcomes <- c(ssi_list, "h5ss0b", "h4pe6", "h4pe7") #depression, anxiety, optimism

final_data_corr <- data_combined_all %>%
  dplyr::select(aid, tidyselect::all_of(ssi_and_outcomes))

# Plot correlation funnel h5ss0b:felt depressed variable. Note, all missing values are dropped.
final_data_corr %>% 
  dplyr::select(-aid) %>% 
  drop_na() %>%
  correlationfunnel::correlate("h5ss0b", method = "kendall") %>% 
  correlationfunnel::plot_correlation_funnel()

final_data_corr %>% 
  dplyr::select(-aid) %>% 
  drop_na() %>%
  correlationfunnel::correlate("h4pe6", method = "kendall") %>% 
  correlationfunnel::plot_correlation_funnel()

final_data_corr %>% 
  dplyr::select(-aid) %>% 
  drop_na() %>%
  correlationfunnel::correlate("h4pe7", method = "kendall") %>% 
  correlationfunnel::plot_correlation_funnel()

```


The correlation funnels do not show any particularly notable correlations with the selected outcomes.


<br><br><br><br><br><br>