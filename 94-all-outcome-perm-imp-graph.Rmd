---
title: "94-all-outcome-perm-imp-graph"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r source files, include=FALSE}
source("function_import.R")
```

```{r load libraries, include=FALSE}
# Use pacman, which forces an install if the library isn't present on the running machine
if (!require("pacman")) install.packages("pacman")
#pacman::p_install(plotly)
pacman::p_load(tidyverse, h2o, furrr)
```

```{r}
library(ggplot2)
library(ROCR)
library(reshape2)
```



#feature distribution across bootstrap

```{r}
load_from_csv <- function(read_var, read_dir = '.', notasks = NULL, best_ind = NULL){
  #Function load_from_csv: loads dataframes from 'read_dir/[read_var]_[1:notasks].csv
  #read_var: variable name, usually what the data is saved under
  #read_dir (default '.'): string reflecting base directory;
  #notasks: total number of processes that have this file
  #best_ind: specific process index to read.  If specified, `notasks` is ignored.
  #Returns: the generated dataframe from all processes
  
  #get variable name as string
  read_var_str <- deparse(substitute(read_var))
  print(read_var_str)
  
  if(!is.null(best_ind))
    inds_to_read = best_ind
  else{
    if(length(notasks)==1){
      inds_to_read <- seq(1, notasks)
      print(inds_to_read)
    }
    else{
      inds_to_read <- notasks
      print(inds_to_read)
    }
  }
  
  #generate file strings
  read_fnames <- str_c(read_dir, str_c('/', read_var_str, '_', inds_to_read, '.csv'))
  print(read_fnames)
  
  #read the csvs
  read_data <- map_dfr(read_fnames, read_csv)
  
  #return the data
  return(read_data)
}

```
# old

```{r seeds for reproducibility}
outcome = 'prob_drink'
fbase = '/scratch/p_gaydosh_dsi/DSI/'
#fbase = '/scratch/p_gaydosh_dsi/'
results_directory <- str_c(fbase, outcome, '/results_run_0316_2')
```


```{r}
no_tasks <- get_good_task_ids(results_directory)

bs_rf_perm_plt = NULL

# get data files
bs_rf_perm_plt = load_from_csv(bs_rf_perm_plt, results_directory, no_tasks)
```

```{r}
nrow(bs_rf_perm_plt)
```


```{r}
distinct(bs_rf_perm_plt, variable)
```


```{r}
bs_rf_perm_plt
```

so the order of the dataset if by bootstraps
```{r}
bs_rf_perm_plt[1,]
bs_rf_perm_plt[111,]
bs_rf_perm_plt[221,]
```


```{r}
bootstrap500_with_rank <- bs_rf_perm_plt %>%
  group_by(variable) %>%
  mutate(bootstrap_serial = row_number()) %>%
  ungroup() %>%
  group_by(bootstrap_serial) %>%
  arrange(desc(pr_auc), .by_group = TRUE) %>%
  mutate(placement = row_number()) %>%
  ungroup()
```


```{r}
bs_rf_perm_plt_rank <- bootstrap500_with_rank %>%
  select(variable, placement)


bs_rf_perm_plt_rank
```

```{r, fig.width=120, fig.height=300}
#dev.new(width=5000, height=4000)    

ggplot(data=bs_rf_perm_plt_rank, aes(x=placement)) + 
    geom_histogram() + 
    facet_grid(variable ~ .,) +
    theme(aspect.ratio=3/4) + 
    facet_wrap(vars(variable), nrow = 20)+   theme(strip.text = element_text(size=60)) 
  
```




If we want to check the first 20
```{r}
met <- 'pr_auc'

bs_rf_perm_20 <- bs_rf_perm_plt %>%
  get_permute_placement(metric_oi=met) %>%
  top_n(20)


bs_rf_perm_20_variable <- bs_rf_perm_20 %>%
  select(predictor) %>%
  rename(variable=predictor)
```


```{r}
bs_rf_perm_20_variable
```



```{r}
bs_rf_perm_plt_rank_20 <- bs_rf_perm_plt_rank %>%
  inner_join(bs_rf_perm_20_variable)

bs_rf_perm_plt_rank_20
```

```{r}
bs_rf_perm_plt_rank_20_graph <- bs_rf_perm_plt_rank_20 %>% 
  arrange(placement) %>% # sort
  mutate_at(vars(variable), funs(factor(., levels=unique(.))))
```

```{r}
bs_rf_perm_plt_rank_20_graph
```


# final model permutation
```{r}
## set outcome variable of interest
seed = 9384
filebase = '/scratch/p_gaydosh_dsi'

#create data in specified form
dataset_list <- generate_datasets(outcome, binarize=FALSE, filebase=filebase, seed_val=seed)

#parse out dataset components
full_dataset <- dataset_list$full_dataset
```


```{r compute/save or load final rf model permutation}
final_rf_perf = NULL
  
# read file array
final_rf_perfs = load_from_csv(final_rf_perf, results_directory, no_tasks)

# get the index of the best performance and best performance
final_rfmodel_ind <- which.max(dplyr::select(final_rf_perfs, met) %>% pull(met))

final_rf_perm_plt = NULL
  
# read best perm plt
final_rf_perm_plt = load_from_csv(final_rf_perm_plt, results_directory, best_ind=no_tasks[[final_rfmodel_ind]])

final_rf_perm <- final_rf_perm_plt %>%
  get_permute_placement(metric_oi=met) %>%
  add_attribute_names('predictor', full_dataset) %>%
  dplyr::select(predictor, everything())
```

```{r}
final_rf_perm_rank <- final_rf_perm %>%
  select(predictor, overall_rank) %>%
  rename(variable=predictor)


final_rf_perm_rank
```


```{r}
final_rf_perm_rank_graph <- bs_rf_perm_20_variable %>%
  left_join(final_rf_perm_rank)

final_rf_perm_rank_graph
```

#add highlight part to the graph

```{r}
bs_rf_perm_plt_rank_20_graph
```

```{r}
rf_perm_for_graph <- bs_rf_perm_plt_rank_20_graph %>%
  left_join(final_rf_perm_rank_graph) %>%
  mutate(ToHighlight = ifelse(placement == overall_rank, "yes", "no")) %>%
  select(-c(overall_rank))

rf_perm_for_graph
```

```{r}
rf_perm_for_graph <- rf_perm_for_graph %>% 
  arrange(placement) %>% # sort
  mutate_at(vars(variable), funs(factor(., levels=unique(.))))
```


Graph for the first 20
```{r, fig.width=150, fig.height=200}
#dev.new(width=5000, height=4000)    

ggplot(data=rf_perm_for_graph, aes(x=placement, fill = factor(ToHighlight))) + 
    geom_histogram(binwidth = 1) + 
    facet_grid(variable ~ .,) +
    theme(aspect.ratio=3/4)
# + 
#     facet_wrap(vars(variable), nrow = 4)+   theme(strip.text = element_text(size=60)) + theme(axis.text.y = element_text(size = 50))
  
```


```{r, fig.width=10, fig.height=20}
library(ggridges)

ggplot(rf_perm_for_graph, aes(x = placement, y = variable,height = stat(count), fill = factor(ToHighlight))) +
  geom_density_ridges(stat="binline", bins = 20, binwidth = 1, scale = 5, draw_baseline = FALSE)+ 
  scale_fill_discrete(name = "", labels = c("bootstraps", "final model falls"))
```

# add domain variables groups
```{r}
library(readxl)
Variables_of_Interest <- read_excel("Variables_of_Interest.xlsx", 
    sheet = "Predictor Vars by File")
```


```{r}
Variables_of_Interest <- Variables_of_Interest %>%
  select(Category, `Variable Name`) %>%
  mutate(`Variable Name` = tolower(`Variable Name`)) %>%
  rename(variable=`Variable Name`)

Variables_of_Interest
```


```{r}
rf_perm_in_domain_for_graph <- rf_perm_for_graph %>%
  left_join(Variables_of_Interest)

rf_perm_in_domain_for_graph$Category[is.na(rf_perm_in_domain_for_graph$Category)] <- "No group"

rf_perm_in_domain_for_graph
```

```{r}
rf_perm_in_domain_for_graph <- rf_perm_in_domain_for_graph %>% 
  arrange(desc(placement)) %>% # sort
  mutate_at(vars(variable), funs(factor(., levels=unique(.))))
```


```{r, fig.width=8, fig.height=20}
ggplot(rf_perm_in_domain_for_graph, aes(x = placement, y = variable,height = stat(count), fill = factor(Category))) +
  geom_density_ridges(data=subset(rf_perm_in_domain_for_graph,ToHighlight == "yes"), fill="#d96473", stat="binline", bins = 20, binwidth = 1, scale = 2, draw_baseline = FALSE) +
  geom_density_ridges(data=subset(rf_perm_in_domain_for_graph,ToHighlight == "no"), stat="binline", bins = 20, binwidth = 1, scale = 2, draw_baseline = FALSE) +
  scale_fill_manual(values = c("#f2d5d5","#f2edd5","#dff2d5","#d5e2f2","#e9d5f2"))
```





# RF Model
##Test on some outcomes:
1. use the way that calculate top 20, mutate a new column with a rank (A, B, C)
2. Generate another table based on another outcome
3. Generate another table 
4. merge tables:

feature   outcome1   outcome2
1          A           B
2          A           C
3          B           A

### 1.
```{r seeds for reproducibility}
outcome_p = 'p_drug'
fbase_p = '/scratch/p_gaydosh_dsi/DSI/'
results_directory_p <- str_c(fbase_p, outcome_p, '/results_3.17')
```


```{r}
no_tasks_p <- get_good_task_ids(results_directory_p)

bs_rf_perm_plt = NULL

# get data files
bs_rf_perm_plt_p = load_from_csv(bs_rf_perm_plt, results_directory_p, no_tasks_p)
```

```{r}
rank_group<-rep(c(116:1))
df<-data.frame(rank_group)
df

```

```{r}
met <- 'pr_auc'

bs_rf_perm_p_perc_rank <- bs_rf_perm_plt_p %>%
  get_permute_placement(metric_oi=met)
  
bs_rf_perm_p_perc_rank <- cbind(bs_rf_perm_p_perc_rank, df)  
```

```{r}
bs_rf_perm_p_perc_rank <- bs_rf_perm_p_perc_rank %>%
  select(predictor, rank_group) %>%
  rename(p_drug = rank_group)

bs_rf_perm_p_perc_rank
```

### 2
```{r seeds for reproducibility}
outcome_h5mn8 = 'h5mn8'
fbase_h5mn8 = '/scratch/p_gaydosh_dsi/DSI/'
results_directory_h5mn8 <- str_c(fbase_h5mn8, outcome_h5mn8, '/new_data_1')
```

```{r}

  ran_files_h5mn8 <- list.files(results_directory_h5mn8)
  
  map(ran_files_h5mn8, ~str_extract(., "\\d+")) %>%
    unlist() %>%
    tibble() %>%
    rename(ids='.') %>%
    group_by(ids) %>%
    summarise(counts=n(), .groups='drop_last') %>%
    filter(counts==max(counts)) %>%
    slice(c(1:20)) %>%
    pull(ids)
```

```{r}
no_tasks_h5mn8 <- get_good_task_ids(results_directory_h5mn8)

bs_rf_perm_plt = NULL

# get data files
bs_rf_perm_plt_h5mn8 = load_from_csv(bs_rf_perm_plt, results_directory_h5mn8, no_tasks_h5mn8)
```

```{r}
bs_rf_perm_h5mn8_perc_rank <- bs_rf_perm_plt_h5mn8 %>%
  get_permute_placement(metric_oi=met)
  
bs_rf_perm_h5mn8_perc_rank <- cbind(bs_rf_perm_h5mn8_perc_rank, df)  
```

```{r}
bs_rf_perm_h5mn8_perc_rank <- bs_rf_perm_h5mn8_perc_rank %>%
  select(predictor, rank_group) %>%
  rename(h5mn8 = rank_group)

bs_rf_perm_h5mn8_perc_rank
```
### 3
```{r seeds for reproducibility}
outcome = 'prob_drink'
fbase = '/scratch/p_gaydosh_dsi/DSI/'
results_directory_pdrink <- str_c(fbase, outcome, '/results_run_0316_25')
```

```{r}

  ran_files_pdrink <- list.files(results_directory_pdrink)
  
  map(ran_files_pdrink, ~str_extract(., "\\d+")) %>%
    unlist() %>%
    tibble() %>%
    rename(ids='.') %>%
    group_by(ids) %>%
    summarise(counts=n(), .groups='drop_last') %>%
    filter(counts==max(counts)) %>%
    slice(c(1:20)) %>%
    pull(ids)
```

```{r}
no_tasks_pdrink <- get_good_task_ids(results_directory_pdrink)

bs_rf_perm_plt = NULL

# get data files
bs_rf_perm_plt_pdrink = load_from_csv(bs_rf_perm_plt, results_directory_pdrink, no_tasks_pdrink)
```


```{r}
bs_rf_perm_pdrink_perc_rank <- bs_rf_perm_plt_pdrink %>%
  get_permute_placement(metric_oi=met)
  
bs_rf_perm_pdrink_perc_rank <- cbind(bs_rf_perm_pdrink_perc_rank, df)  
```

```{r}
bs_rf_perm_pdrink_perc_rank <- bs_rf_perm_pdrink_perc_rank %>%
  select(predictor, rank_group) %>%
  rename(pdrink = rank_group)

bs_rf_perm_pdrink_perc_rank
```

### 4
```{r seeds for reproducibility}
outcome = 'i_drug'
fbase = '/scratch/p_gaydosh_dsi/DSI/'
results_directory_idrug <- str_c(fbase, outcome, '/new_data_1')
```

```{r}

  ran_files_idrug <- list.files(results_directory_idrug)
  
  map(ran_files_idrug, ~str_extract(., "\\d+")) %>%
    unlist() %>%
    tibble() %>%
    rename(ids='.') %>%
    group_by(ids) %>%
    summarise(counts=n(), .groups='drop_last') %>%
    filter(counts==max(counts)) %>%
    slice(c(1:20)) %>%
    pull(ids)
```

```{r}
no_tasks_idrug <- get_good_task_ids(results_directory_idrug)

bs_rf_perm_plt = NULL

# get data files
bs_rf_perm_plt_idrug = load_from_csv(bs_rf_perm_plt, results_directory_idrug, no_tasks_idrug)
```
```{r}
bs_rf_perm_idrug_perc_rank <- bs_rf_perm_plt_idrug %>%
  get_permute_placement(metric_oi=met)
  
bs_rf_perm_idrug_perc_rank <- cbind(bs_rf_perm_idrug_perc_rank, df)  
```

```{r}
bs_rf_perm_idrug_perc_rank <- bs_rf_perm_idrug_perc_rank %>%
  select(predictor, rank_group) %>%
  rename(idrug = rank_group)

bs_rf_perm_idrug_perc_rank
```


### 5
```{r}
combined_outcome_rank_group <- inner_join(bs_rf_perm_pdrink_perc_rank, bs_rf_perm_idrug_perc_rank)
combined_outcome_rank_group <- inner_join(combined_outcome_rank_group, bs_rf_perm_h5mn8_perc_rank)
combined_outcome_rank_group <- inner_join(combined_outcome_rank_group, bs_rf_perm_p_perc_rank)
combined_outcome_rank_group
```

```{r}
variable_labels <- read_xlsx("variables_labels.xlsx")
variable_labels
```


```{r}
library(plyr)
library(dplyr)
```


```{r}
combined_outcome_rank_group_labeled <- join(combined_outcome_rank_group, variable_labels)
combined_outcome_rank_group_labeled <- combined_outcome_rank_group_labeled %>%
  select(-c("predictor")) %>%
  dplyr::rename(predictor = label)
combined_outcome_rank_group_labeled
```

```{r}
combined_outcome_rank_group_labeled_graph <- combined_outcome_rank_group_labeled %>% dplyr::rename(`Prob. drink` = pdrink,
                                                                                                   `Ill. drug` = idrug,
                                                                                                   `Suic. idea.` = h5mn8,
                                                                                                   `Rx abuse` = p_drug) 
```



```{r}
combined_outcome_rank_group_labeled_graph2 <- combined_outcome_rank_group_labeled_graph
```

```{r}
library(reshape2)
```


```{r}
combined_outcome_rank_group_labeled_graph2 = reshape2::dcast(
   dplyr::mutate(
      reshape2::melt(combined_outcome_rank_group_labeled_graph,id.var="predictor"),
      value=plyr::mapvalues(
           value, c("A","B","C","D","E","F","G","H","I","J","K"),c(11,10,9,8,7,6,5,4,3,2,1))
   ),predictor~variable)

combined_outcome_rank_group_labeled_graph2[, 2:ncol(combined_outcome_rank_group_labeled_graph2)] <- lapply(2:ncol(combined_outcome_rank_group_labeled_graph2), function(x) as.numeric(combined_outcome_rank_group_labeled_graph2[[x]]))
combined_outcome_rank_group_labeled_graph2 <- combined_outcome_rank_group_labeled_graph2 %>% arrange(`Prob. drink`)
```

```{r}
combined_outcome_rank_group_labeled_graph2 <- combined_outcome_rank_group_labeled_graph2[,c("predictor", "Prob. drink", "Ill. drug", "Rx abuse", "Suic. idea.")]

combined_outcome_rank_group_labeled_graph2
```



```{r}
#cols <- rainbow(nrow(combined_outcome_rank_group_labeled))

dat3 <- melt(combined_outcome_rank_group_labeled_graph2, id.var = 'predictor')

dat4 <- data.frame(predictor=factor(dat3$predictor,levels=unique(dat3$predictor)), variable = dat3$variable, value = dat3$value)
```

```{r}
library(grDevices)
```


```{r, fig.width=8, fig.height=12}

ggplot(dat4, aes(variable, predictor)) + geom_tile(aes(fill = as.numeric(value)), colour = "white") + scale_fill_gradientn("", colours = c("#fce7ac", "#db2c66", "#3d0438"),
                        breaks=c(min(dat4$value),max(dat4$value)),
                        labels=c("Least important","Most important")) + scale_x_discrete(name ="Outcomes") + scale_y_discrete(name ="Features")

```



```{r}
combined_outcome_rank_group_labeled_graph3 <- combined_outcome_rank_group_labeled_graph2[order(combined_outcome_rank_group_labeled_graph2$`Ill. drug`), ]


combined_outcome_rank_group_labeled_graph3
```



```{r}
#cols <- rainbow(nrow(combined_outcome_rank_group_labeled))

dat3 <- melt(combined_outcome_rank_group_labeled_graph3, id.var = 'predictor')

dat4 <- data.frame(predictor=factor(dat3$predictor,levels=unique(dat3$predictor)), variable = dat3$variable, value = dat3$value)
```


```{r, fig.width=8, fig.height=12}

ggplot(dat4, aes(variable, predictor)) + geom_tile(aes(fill = as.numeric(value)), colour = "white") + scale_fill_gradientn("", colours = c("#fce7ac", "#db2c66", "#3d0438"),
                        breaks=c(min(dat4$value),max(dat4$value)),
                        labels=c("Least important","Most important")) + scale_x_discrete(name ="Outcomes") + scale_y_discrete(name ="Features")

```


```{r}
combined_outcome_rank_group_labeled_graph4 <- combined_outcome_rank_group_labeled_graph2[order(combined_outcome_rank_group_labeled_graph2$`Rx abuse`), ]


combined_outcome_rank_group_labeled_graph4
```



```{r}
#cols <- rainbow(nrow(combined_outcome_rank_group_labeled))

dat3 <- melt(combined_outcome_rank_group_labeled_graph4, id.var = 'predictor')

dat4 <- data.frame(predictor=factor(dat3$predictor,levels=unique(dat3$predictor)), variable = dat3$variable, value = dat3$value)
```


```{r, fig.width=8, fig.height=12}

ggplot(dat4, aes(variable, predictor)) + geom_tile(aes(fill = as.numeric(value)), colour = "white") + scale_fill_gradientn("", colours = c("#fce7ac", "#db2c66", "#3d0438"),
                        breaks=c(min(dat4$value),max(dat4$value)),
                        labels=c("Least important","Most important")) + scale_x_discrete(name ="Outcomes") + scale_y_discrete(name ="Features")

```



```{r}
combined_outcome_rank_group_labeled_graph5 <- combined_outcome_rank_group_labeled_graph2[order(combined_outcome_rank_group_labeled_graph2$`Suic. idea.`), ]


combined_outcome_rank_group_labeled_graph5
```



```{r}
#cols <- rainbow(nrow(combined_outcome_rank_group_labeled))

dat3 <- melt(combined_outcome_rank_group_labeled_graph5, id.var = 'predictor')

dat4 <- data.frame(predictor=factor(dat3$predictor,levels=unique(dat3$predictor)), variable = dat3$variable, value = dat3$value)
```


```{r, fig.width=8, fig.height=12}

ggplot(dat4, aes(variable, predictor)) + geom_tile(aes(fill = as.numeric(value)), colour = "white") + scale_fill_gradientn("", colours = c("#fce7ac", "#db2c66", "#3d0438"),
                        breaks=c(min(dat4$value),max(dat4$value)),
                        labels=c("Least important","Most important")) + scale_x_discrete(name ="Outcomes") + scale_y_discrete(name ="Features")

```