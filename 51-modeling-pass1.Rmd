---
title: "51-modeling-pass1"
output: html_document
---

The purpose of this document is to create the models used for the exploration in the file 60 series.

```{r load libraries}
# these are the libraries needed to run the code below
library(data.table)
library(mlr)
library(splitstackshape) #stratified function
library(boot)
library(tidyverse)
library(rsample)
```


```{r convenience functions}

# This function performs a stratified split
strat_split <- function(df, strat_var, split_prop, train_out = T){
  # df: input dataframe
  # strat_var: variable to stratify on
  # train_prop: proption to split for train/testing
  # train_out: set to TRUE for training frame, set to FALSE for validation frame
  # returns: training or testing tibble
  
  # create stratified split
  splits <- stratified(df, strat_var, split_prop, bothSets = T)
  train <- splits[[1]]
  test <- splits[[2]]
  
  # return tibble of training set if train_out == True
  if(train_out == T){out <- train}
  else{out<-test}
  
  
  return(out)
}


# Get names of variables for top n predictors of decision tree
# This should be called in the for loop after building the model on each bootstrap. 
# Save the result in a list - see example below
get_top_n_names <- function(model_h2o, top_n){
  # model_h2o: The h2o model object
  # top_n: The number of predictors to look at
  # return: data frame of variable importance
  
  # get names for top_n predictors
  out <- h2o.varimp(model_h2o)[1:top_n,1] %>% 
    as.data.frame() %>% 
    mutate_all(as.character)
  
  # add row_index
  out <- out %>% mutate(placement = as.numeric(rownames(out)))
  
  # rename the period as variable name
  names(out) <- c("variable", "placement")
  
  # return top_n predictors 
  return(out)
}

# Example
# h2o_model_list[[i]] <- h2o_model %>% get_top_n_names(top_n = 50) %>% as_tibble()
```


```{r create splits for training and testing on suicide_df}
# Get training frame
training_df <- suicide_df %>% 
  strat_split(strat_var = c("h5mn8"),split_prop = 0.7, train_out = TRUE)

# Get testing frame
testing_df <- suicide_df %>% 
  strat_split(c("h5mn8"),0.7, FALSE)
```

```{r build suicide model}

# n number of bootstraps to run the model on
n = 2 # 

#create bootstraps list
straps <- training_df %>%bootstraps(times = n, strata = c("h5mn8"))

#lists to store results and models that are created on each bootstrap
combined_models <- list()
combined_performances <- list()
variable_imps <- list()

# These are the tuning parameters that we decide to tune.
max_depths <- c(5,10,25)
ntrees <- c(100,150,200)

# Train the model on each of the bootstraps and get the performance 
for(i in 1:length(straps$splits)){
  results <- as.data.frame(straps$splits[[i]])%>%
    rf_model(outcome = c("h5mn8"))
  
  combined_models[i] <- results[1]
  combined_performances[i] <- results[2]
  variable_imps[[i]] <- get_top_n_names(results[[1]], 20)
  
}


```


