---
title: "30-feature-engineering"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

# Predictive Features

Which feature/attribute we are more interested in: probably a one that shared by all of the independent units on which prediction is to be done. Choosing the right features is important. Better features can produce simpler and more flexible models, and they often yield better results.

### Add Wave 3 BMI
Wave 3 BMI must be constructed from three other variables. 

```{r}
# This function takes in weight(lbs) and height(feet, inches - example : 6ft 2in) and returns the BMI after converting the weight to kgs and height to ms 
add_wave_3_bmi <- function(df){
  
  # df - full dataframe with the weight and height variables present
  # "h3wgt" - weight(in lbs) variable name passed as string. Converted to kgs by dividing by 2.2
  # "h3hgt_f", "h3hgt_i" - height variable names passed as string. 
  ### Converted to ms by:
  ### 1. converting height_ft to inches by multiplying by 12
  ### 2. Adding it to height_in to get total height in inches
  ### 3. Dividing by 39.37 to get height in ms
  # h3bmi is the new variable added to the dataframe. FORMULA weight(in kgs)/(height(in ms))^2
  # return: df with h3bmi in it. 
  
  df['weight_kg'] <- df[["h3wgt"]]/2.2 # lbs -> kgs
  df['height_m'] <- (df[["h3hgt_f"]]*12 + df[["h3hgt_i"]])/39.37 # inches -> meters
  df['h3bmi'] <- df[['weight_kg']]/(df[['height_m']] * df[['height_m']])  # bmi calculation
  
  df <- df %>% select(aid, h3bmi, everything())
  return(df)
}

# Example
# full_dataset %>% 
#   add_wave_3_bmi()
```

# Outcome variables

These functions create the outcomes of prescription and illegal drug use.
```{r prescription drug constructed variable}
add_pres_drug <- function(df){
  # add_pres_drug: constructs prescription drug use from variables in core wave 5 dataframe
  # df : joined waves input
  # return : new data frame with additional variable indicating prescription drug use
  df %>% 
    mutate(p_drug = case_when(
      ((h5to26a == 1)|(h5to26b == 1)|(h5to26c == 1)|(h5to26d == 1)) ~ 1,
      #TRUE ~ 0)
      ((h5to26a == 0)&(h5to26b == 0)&(h5to26c == 0)&(h5to26d == 0)) ~ 0)
    )
}
```

```{r illegal drug use constructed variable}
add_ill_drug <- function(df){
  # add_ill_drug: constructs illegal drug use from variables in core wave 5 dataframe
  # df : joined waves input
  # return : new data frame with additional variable indicating illegal drug use
  df %>% 
    mutate(i_drug = case_when(
      ((h5to27a == 1)|(h5to27b == 1)|(h5to27c == 1)|(h5to27d == 1)) ~ 1,
      ((h5to27a == 0)&(h5to27b == 0)&(h5to27c == 0)&(h5to27d == 0)) ~ 0)
    )
}
```

#Add heavy drinking variable (by sex)
```{r}
add_hv_drink <- function(df){
  
  # df - full dataframe with the original drinking data
  #h5to11- ever drink alcohol; if not then 0
  #h5to12- past 12 months drink; if 0 then 0
  # h5to13- drink days in past 30 days, if 0 then 0
  #else, calculate days per month with drinking using h5to13
  #multiply drinking days per month by answer from h5to14 to get monthly drinks
  #divide by four for average drinks per week
  # >15 for men or >8 for women, then 1
  
  df %>%  
    mutate(days_per_month = case_when( #4 weeks in 30 days
      (h5to13==1) ~ 1,
      (h5to13==2) ~ 2.5,
      (h5to13==3) ~ 4,
      (h5to13==4) ~ 8,
      (h5to13==5) ~ 16,
      (h5to13==6) ~ 26)
    ) %>%
    
    mutate(weekly_drinks = (days_per_month * h5to14) / 4) %>%
 
    #df['weekly_drinks'] <- (df[["h5to14"]] * df[["days_per_month"]]) / 4
    
    mutate(hv_drink = case_when(
      #sex at birth
      ((weekly_drinks>15) & (h5od2a==1))|((weekly_drinks>8)&(h5od2a==2)) ~ 1,
      ((weekly_drinks<=15) & (h5od2a==1))|((weekly_drinks<=8)&(h5od2a==2)| 
         (h5to11 == 0)|(h5to12 == 0)|(h5to13 == 0)) ~ 0)
    )
  
}

# Example
# full_dataset %>% 
#   add_hv_drink()
```

#Add binge/problematic drinking
```{r}
#combine all drinking variables to calculate whether there was binge drinking in past year
#female 4+ drinks, male 5+ drinks as asked in h5to15
#encode 97 and all NAs as NA, use this for real test
add_prob_drink <- function(df){
  df %>% 
    mutate(prob_drink = case_when(
      
      ((h5to15>=1) & (h5to15 <= 6)) ~ 1,
      ((h5to11 == 0)|(h5to12 == 0)|(h5to15==0)) ~ 0)
    )
  
}

# #same as above but added a line to encode specific 97 category just to check distributuon
# add_prob_drink_97 <- function(df){
#   df %>% 
#     mutate(prob_drink = case_when(
#       
#       ((h5to15>=1) & (h5to15 <= 6)) ~ 1,
#       ((h5to11 == 0)|(h5to12 == 0)|(h5to15==0)) ~ 0,
#       (h5to15 == 97) ~ 97
#     ))
#   
# }
```



Here are functions and aggregate "lists" that we can use to add all constructed outcome variables.  Create your outcome variables in the same manner as `add_pres_drug` and `add_ill_drug` above.  Add the name of the variable to the vector below.  Then, add the function to the `add_constructed_outcomes` function below so that it can be constructed and added to the full modeling dataframe.

```{r}
constructed_outcomes = c('p_drug', 'i_drug', 'hv_drink', 'prob_drink')

constructed_ind_vars = c('p_health', 'close_father', 'close_mother', 'mother_support', 'mother_support2', 'father_support', 'father_support2', 'mother_warmth', 'father_warmth', 'industry_code3', 'industry_code4', 'h5tr4_t', 'h5tr5_t', 'h5tr6_t', 'h5tr7_t')

constructed_vars_all = c(constructed_outcomes, constructed_ind_vars)
```


```{r add all constructed variables}
add_constructed_outcomes <- function(df){
  # add_constructed_outcomes: constructs illegal drug use from variables in core wave 5 dataframe
  # df : joined waves input
  # return : new data frame with all additional specified constructed outcome variables
  
  df <- df %>%
    add_pres_drug() %>%
    add_ill_drug() %>%
    add_hv_drink() %>%
    add_prob_drink()
    
  
  return(df)
}

```

```{r add constructed individual relevant variables}

add_parent_health <- function(df){
  # df : joined waves input
  # return : new data frame including additional variable about parental health insurance
  # works assuming each person has only 1 type of health insurance
  # drop unnecessary columns?
  df <- df %>% 
    mutate(p_health = case_when(
      (pc21_1 == 1)&(pc21_2 != 1)&(pc21_3 != 1)&(pc21_4 != 1)&(pc21_5 != 1)&(pc21_6 != 1)&(pc21_7 != 1) ~ 1,
      (pc21_1 != 1)&(pc21_2 == 1)&(pc21_3 != 1)&(pc21_4 != 1)&(pc21_5 != 1)&(pc21_6 != 1)&(pc21_7 != 1) ~ 2,
      (pc21_1 != 1)&(pc21_2 != 1)&(pc21_3 == 1)&(pc21_4 != 1)&(pc21_5 != 1)&(pc21_6 != 1)&(pc21_7 != 1) ~ 3,
      (pc21_1 != 1)&(pc21_2 != 1)&(pc21_3 != 1)&(pc21_4 == 1)&(pc21_5 != 1)&(pc21_6 != 1)&(pc21_7 != 1) ~ 4,
      (pc21_1 != 1)&(pc21_2 != 1)&(pc21_3 != 1)&(pc21_4 != 1)&(pc21_5 == 1)&(pc21_6 != 1)&(pc21_7 != 1) ~ 5,
      (pc21_1 != 1)&(pc21_2 != 1)&(pc21_3 != 1)&(pc21_4 != 1)&(pc21_5 != 1)&(pc21_6 == 1)&(pc21_7 != 1) ~ 6,
      (pc21_1 != 1)&(pc21_2 != 1)&(pc21_3 != 1)&(pc21_4 != 1)&(pc21_5 != 1)&(pc21_6 != 1)&(pc21_7 == 1) ~ 7,
      (pc21_1 != 1)&(pc21_2 != 1)&(pc21_3 != 1)&(pc21_4 != 1)&(pc21_5 != 1)&(pc21_6 != 1)&(pc21_7 != 1) ~ 0,
      TRUE ~ 9999))

}

add_w3_family<- function(df) {
  #df : joined waves input
  #return : new data frame with constructed family variables
  #combines variables by prioritizing first variable in list to create the following:
  #close_mother combines "h3wp20", "h3wp32", "h3wp46", "h3wp64"
  #close_father combines "h3wp25", "h3wp39", "h3wp53"
  #mother_support combines "h3wp21", "h3wp33", "h3wp47"
  #mother_support2 combines "h3wp22", "h3wp34", "h3wp48"
  #father_support combines "h3wp26", "h3wp40", "h3wp54"
  #father_support2 combines "h3wp27", "h3wp41", "h3wp55"
  #mother_warmth combines "h3wp19", "h3wp31", "h3wp45", "h3wp63"
  #father_warmth combines "h3wp24", "h3wp38", "h3wp52"
  
  #takes average of all answers, excluding NAs 
  #sibling_closeness combines "h3ws5a", "h3ws5b", "h3ws5c", "h3ws5d"
  #sibling_support combines "h3ws6a", "h3ws6b", "h3ws6c", "h3ws6d"
  
  #list of valid values 
  
  valid_vars <- c(1,2,3,4,5)
  support <- c(0,1)
  support2 <- c(1,2,3,4)
  sibling_valid <- c(0,1,2,3,4)
  
  df <- df %>% 
    mutate(close_father = case_when(h3wp25 %in% valid_vars ~ h3wp25,
                                     h3wp39 %in% valid_vars & !(h3wp25 %in% valid_vars) ~ h3wp39,
                                     !(h3wp39 %in% valid_vars) & !(h3wp25 %in% valid_vars) & (h3wp53 %in% valid_vars) ~ h3wp53,
                                     TRUE ~ 9999),
           close_mother = case_when(h3wp20 %in% valid_vars ~ h3wp20,
                                     h3wp32 %in% valid_vars & !(h3wp20 %in% valid_vars) ~ h3wp32,
                                     !(h3wp32 %in% valid_vars) & !(h3wp20 %in% valid_vars) & (h3wp46 %in% valid_vars) ~ h3wp46,
                                     !(h3wp32 %in% valid_vars) & !(h3wp20 %in% valid_vars) & !(h3wp46 %in% valid_vars) & (h3wp64 %in% valid_vars) ~ h3wp64,
                                     TRUE ~ 9999),
           mother_support = case_when(h3wp21 %in% support ~ h3wp21,
                                     h3wp33 %in% support & !(h3wp21 %in% support) ~ h3wp33,
                                     !(h3wp33 %in% support) & !(h3wp21 %in% support) & (h3wp47 %in% support) ~ h3wp47,
                                     TRUE ~ 9999),
           mother_support2 = case_when(h3wp22 %in% support2 ~ h3wp22,
                                     h3wp34 %in% support2 & !(h3wp22 %in% support2) ~ h3wp34,
                                     !(h3wp34 %in% support2) & !(h3wp22 %in% support2) & (h3wp48 %in% support2) ~ h3wp48,
                                     TRUE ~ 9999),
           father_support = case_when(h3wp26 %in% support ~ h3wp26,
                                     h3wp40 %in% support & !(h3wp26 %in% support) ~ h3wp40,
                                     !(h3wp40 %in% support) & !(h3wp26 %in% support) & (h3wp54 %in% support) ~ h3wp54,
                                     TRUE ~ 9999),
           father_support2 = case_when(h3wp27 %in% support2 ~ h3wp27,
                                     h3wp41 %in% support2 & !(h3wp27 %in% support2) ~ h3wp41,
                                     !(h3wp41 %in% support2) & !(h3wp27 %in% support2) & (h3wp55 %in% support2) ~ h3wp55,
                                     TRUE ~ 9999),
           mother_warmth = case_when(h3wp19 %in% valid_vars ~ h3wp19,
                                     h3wp31 %in% valid_vars & !(h3wp19 %in% valid_vars) ~ h3wp31,
                                     !(h3wp31 %in% valid_vars) & !(h3wp19 %in% valid_vars) & (h3wp45 %in% valid_vars) ~ h3wp45,
                                     !(h3wp31 %in% valid_vars) & !(h3wp19 %in% valid_vars) & !(h3wp45 %in% valid_vars) & (h3wp63 %in% valid_vars) ~ h3wp63,
                                     TRUE ~ 9999),
           father_warmth = case_when(h3wp24 %in% valid_vars ~ h3wp24,
                                     h3wp38 %in% valid_vars & !(h3wp24 %in% valid_vars) ~ h3wp38,
                                     !(h3wp38 %in% valid_vars) & !(h3wp24 %in% valid_vars) & (h3wp52 %in% valid_vars) ~ h3wp52,
                                     TRUE ~ 9999),
           h3ws5a = ifelse(!(h3ws5a %in% sibling_valid), NA, h3ws5a),
           h3ws5b = ifelse(!(h3ws5b %in% sibling_valid), NA, h3ws5b),
           h3ws5c = ifelse(!(h3ws5c %in% sibling_valid), NA, h3ws5c),
           h3ws5d = ifelse(!(h3ws5d %in% sibling_valid), NA, h3ws5d),
           h3ws6a = ifelse(!(h3ws6a %in% sibling_valid), NA, h3ws6a),
           h3ws6b = ifelse(!(h3ws6b %in% sibling_valid), NA, h3ws6b),
           h3ws6c = ifelse(!(h3ws6c %in% sibling_valid), NA, h3ws6c),
           h3ws6d = ifelse(!(h3ws6d %in% sibling_valid), NA, h3ws6d)) %>%
    mutate(sibling_closeness = rowMeans(subset(df, select = (c(h3ws5a, h3ws5b, h3ws5c, h3ws5d))), na.rm = TRUE),
           sibling_support = rowMeans(subset(df, select = (c(h3ws6a, h3ws6b, h3ws6c, h3ws6d))), na.rm = TRUE)
           ) 
  
}

add_w3_employ<- function(df){
  #df : joined waves input
  #return : new data frame that includes truncated industry codes
  #truncates values in h3lm25 by keeping first 2 digits
  df <- df %>% 
    mutate(industry_code3 = substr(h3lm25, 1,2))
  
}

add_w4_employ<- function(df){
  #df : joined waves input
  #return : new data frame that includes truncated industry codes
  #truncates values in h4lm18 by keeping first 2 digits
  df <- df %>% 
    mutate(industry_code4 = substr(h4lm18, 1,2))
  
}

add_w5_time <- function(df){
  #combine Y and M columns for h5tr4, h5tr5, h5tr6, h5tr7
  # adds h5tr4_t, h5tr5_t, h5tr6_t, h5tr7_t which combine the number of years and months into total number of months
  df <- df %>% 
    mutate(h5tr4_t = h5tr4y * 12 + h5tr4m, 
           h5tr5_t = h5tr5y * 12 + h5tr5m, 
           h5tr6_t = h5tr6y * 12 + h5tr6m, 
           h5tr7_t = h5tr7y * 12 + h5tr7m)
}


add_constructed_ind_vars <- function(df){
  # add_constructed_ind_vars: constructs all new variables for the individual predictors
  # df: joined waves input
  # return: new dataframe with all added predictor variables
  
  df <- df %>%
    add_parent_health() %>%
    add_w3_family() %>%
    add_w3_employ() %>%
    add_w4_employ() %>%
    add_w5_time()
  
}
```
